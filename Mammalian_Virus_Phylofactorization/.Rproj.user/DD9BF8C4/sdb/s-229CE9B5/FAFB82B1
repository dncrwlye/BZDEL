{
    "collab_server" : "",
    "contents" : "\n# phylobin classificaiton -------------------------------------------------\nsource('R/visualization_fcns.R')\nload('Workspaces/cb_dist_and_IsZoonotic_phylofactorization')\nlibrary(mgcv)\nlibrary(stringi)\nlibrary(dplyr)\nlibrary(purrr)\nlibrary(ReporteRs)\nlibrary(visreg)\nlibrary(gridExtra)\nlibrary(ggpubr)\nlibrary(plyr)\nlibrary(ggplot2)\nlibrary(multcompView)\nsource(\"Olival/R/relative_contributions.R\")\nload('Workspaces/phylofactor_comparisons')  ## gams from before\n\nVmod <- vtraits$model[[1]]\nVmod_new <- vtraits_new$model[[1]]\nClade <- pf.cb_dist_noHoSa_maxLn$basis %>% bins %>% phylobin %>% nms[.] %>% factor\nvnames <- names(Z)\n\nfor (original in c(T,F)){\n  db <- readRDS(\"Olival/intermediates/postprocessed_database.rds\")\n  \n  # our modification\n  if (!original){\n    V <- read.xlsx('Datasets/Olival_w_phylobin_final.xlsx',sheetIndex = 1)\n    db$viruses <- cbind(db$viruses,V[,c('pfIsZ','pfIsZS','nonZ')])\n    db$viruses <- db$viruses[!as.logical(db$viruses$nonZ),]\n  }\n  \n  db$viruses$Clade <- Clade[match(db$viruses$vVirusNameCorrected,vnames)]\n\n  \n  hosts <- db$hosts\n  viruses <- db$viruses\n  associations <- db$associations\n  rm(db)\n  PD_centers = names(viruses)[stri_detect_regex(names(viruses), \"^(cb|st)_.*(?<!stringent)$\")]\n  \n  model_family = binomial\n  \n  \n  data_set = viruses %>%\n    mutate_each_(funs(\"logp\"), vars=PD_centers)\n  names(data_set)[names(data_set) %in% PD_centers] <- paste0(PD_centers, \"Ln\")\n  PD_centers <- paste0(PD_centers, \"Ln\")\n  \n  dummys = as.data.frame(with(viruses, model.matrix(~vFamily))[,-1])\n  data_set = cbind(data_set, dummys)\n  dummy_terms = paste0(\"s(\", names(dummys), \", bs = 're')\")\n  names(dummy_terms) <- names(dummys)\n  \n  \n  terms = list(\n    PD     = paste0(\"s(\", PD_centers, \", bs='tp', k=7)\"),\n    bias   = c(\"s(vPubMedCitesLn, bs='tp', k=7)\", \"s(vWOKcitesLn, bs='tp', k=7)\"),\n    strand = c(\"s(RNA, bs='re')\", \"s(SS, bs='re')\", \"s(vCytoReplicTF, bs='re')\"),\n    vector = \"s(Vector, bs='re')\",\n    env = \"s(Envelope, bs='re')\",\n    cld = \"s(Clade,bs='re')\",\n    genome = \"s(vGenomeAveLengthLn, bs='tp', k=7)\",\n    stringsAsFactors=FALSE)\n  \n  if (original){\n    vtraits_Clade = fit_all_gams(data_set,\n                           outcome_variable = \"IsZoonotic\",\n                           model_family = binomial,\n                           terms)\n    data_set_old <- data_set\n  } else {\n    data_set_new <- data_set\n    vtraits_Clade_new = fit_all_gams(data_set,\n                               outcome_variable = \"IsZoonotic\",\n                               model_family = binomial,\n                               terms)\n  }\n}\n\n\n\n# Visualiztion of Clades --------------------------------------------------\n\ngam_Clade <- vtraits_Clade$model[[1]]\ngam_Clade_new <- vtraits_Clade_new$model[[1]]\n\nix <- setdiff(1:nrow(data_set_old),gam_Clade$na.action)\nddf <- data.frame('IsZoonosis'=gam_Clade$linear.predictors,'Clade'=Clade[ix])\n\nord <- order(by(ddf$IsZoonosis,ddf$Clade,mean),decreasing = T)\nddf$Clade <- factor(ddf$Clade,levels = levels(ddf$Clade)[ord])\n\n\n\n########## Tukey test ############\n\na <- aov(IsZoonosis~Clade, data=ddf)\ntHSD <- TukeyHSD(a, ordered = FALSE, conf.level = 0.95)\n\ngenerate_label_df <- function(HSD, flev){\n  # Extract labels and factor levels from Tukey post-hoc \n  Tukey.levels <- HSD[[flev]][,4]\n  Tukey.labels <- multcompLetters(Tukey.levels)['Letters']\n  plot.labels <- names(Tukey.labels[['Letters']])\n  \n  # Get highest quantile for Tukey's 5 number summary and add a bit of space to buffer between    \n  # upper quantile and label placement\n  boxplot.df <- ddply(ddf, flev, function (x) max(fivenum(x$IsZoonosis)) + 0.2)\n  \n  # Create a data frame out of the factor levels and Tukey's homogenous group letters\n  plot.levels <- data.frame(plot.labels, labels = Tukey.labels[['Letters']],\n                            stringsAsFactors = FALSE)\n  \n  # Merge it with the labels\n  labels.df <- merge(plot.levels, boxplot.df, by.x = 'plot.labels', by.y = flev, sort = FALSE)\n  \n  return(labels.df)\n}\n\n###############\n\n\nlabels.df <- generate_label_df(tHSD, 'Clade')\nlabels.df$plot.labels <- factor(labels.df$plot.labels,levels = levels(ddf$Clade))\nnames(labels.df)[1] <- 'Clade'\n\nggplot(data=ddf,aes(x=Clade,y=IsZoonosis,fill=Clade))+\n  geom_boxplot()+\n  geom_text(data = labels.df, aes(x = Clade, y = V1, label = labels))\n                                                       \nggsave('Figures/cb_dist_Clades_IsZoonotic_by_original_model_selection.tiff',height=5,width=11)\n",
    "created" : 1509648719939.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1916415138",
    "id" : "FAFB82B1",
    "lastKnownWriteTime" : 1509648870,
    "last_content_update" : 1509648870042,
    "path" : "~/Bozeman/BZDEL/Mammalian_Virus_Phylofactorization/Scripts/(5)_cb_dist_gam_analysis.R",
    "project_path" : "Scripts/(5)_cb_dist_gam_analysis.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}