library(phylofactor)
library(grid)
library(gridBase)
library(stringi)
#source('R/other phylofactor scripts/fisherFactor.R')
source('R/taxonomy group name function.R')
#source('R/other phylofactor scripts/visualization_fcns.R')
library(tidyverse)
library(taxize)

# WilcoxTest <- function(grps,tree,Z){
#   s1 <- na.omit(Z[grps[[1]]])
#   s2 <- na.omit(Z[grps[[2]]])
#   wt <- tryCatch(wilcox.test(s1,s2)$p.value,error=function(e) 1)
#   return(wt)
# }

setwd("/Users/buckcrowley/Desktop/BDEL/BZDEL/meta_analysis/")

#..................which african bats have been sampled for filoviruses

load('data/bat_taxonomy_data.Rdada') #oops typo

#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.......................okay going to filter out the results for which we dont have taxonomies
#.......................but really we shouldn't do this and need to figure out the missing taxonomies 

batphy1.africa <- dplyr::filter(batphy1, region == 'Africa') 
batphy1.africa<-batphy1.africa %>%
  mutate(index = row.names(batphy1.africa))

Z <- batphy1.africa$filo_surv

n_factors = 7
#pf <- fisherFactor(Z, africa_tree,10,TestFunction=WilcoxTest,ncores = 1)

pf <- twoSampleFactor(Z, africa_tree, method='Fisher', n_factors ,ncores = 1)

taxonomy_africa<- batphy1.africa[,c('species','tax')]

#names(smry)
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#......................START: alex's slack suggestion.............................................

nms <- list()
  
for (i in 2:length(pf$bins))
{
  indexes = pf$bins[[i]]
  species <- gsub("_", " ", tolower(africa_tree$tip.label[indexes]))
  group_taxonomy_list <- as.data.frame(taxonomy_africa[match(species,taxonomy_africa[,1]),2])
  
  nms[i] <- gsub("\\)|;","", as.character(taxonomy_group_name(group_taxonomy_list)))

  print(i)
}
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
#......................END: alex's slack suggestion...............................................

B <- bins(pf$basis[,1:n_factors])
B <- B[2:n_factors] 
nms1 <- nms[2:(n_factors+1)]

## remove paraphyletic bin

probs <- sapply(B,FUN=function(ix,Z) mean(Z[ix]),Z=Z) %>% signif(.,digits=2)
names(nms1) <- probs


#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#...............Null Simulation..........................................................

null_simulations <- pf.nullsim(pf, reps = 50, nfactors = n_factors, output ='pvals')

#nfactors <- pf$nfactors
obs <- data.frame('Pvals'=pf$pvals,
                  'factor'=1:n_factors
                  )
null_simulations_matrix<- matrix(0,50,n_factors)
for (i in 1:50)
{
  null_simulations_matrix[i,] <- null_simulations[[i]]$pvals
}
null_simulations_matrix <- as.data.frame(t(null_simulations_matrix))
ddf <- cbind(obs,null_simulations_matrix)

ddf %>%
  tidyr::gather(group, pvalue, c(1,3:22)) %>%
  mutate(color = ifelse(group =='Pvals', "observed", 'simulated')) %>%
  ggplot() +
  geom_line(aes(x = factor, y= log(pvalue), group = group, color = color))

#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................
# The Plot ---------------------------------------------------------------

pf.final <- twoSampleFactor(Z, africa_tree, 1 ,ncores = 1) 

pp=pf.tree(pf.final)

gtr <- pp$ggplot+
  ggtree::geom_tippoint(size=3*Z,col='blue') #+ 
  #ggtree::geom_tiplab(aes(angle=angle))

plot.new()
grid.newpage()
pushViewport(viewport(layout = grid.layout(1,2)))
pushViewport(viewport(layout.pos.col = 1))
print(gtr, newpage = FALSE)
popViewport()

#Draw bsae plot
pushViewport(viewport(layout.pos.col = 2))
#par(fig = gridFIG(), new = TRUE)
plot.new()
legend('topleft',legend=Legend[1,'names'],fill=Legend[1,'colors'],cex=1.8)
popViewport()
ggsave('Figures/Sampled_fig.png', gtr, width=15, height=15)

#....................................................................................
#....................................................................................
#....................................................................................
#....................................................................................
#....................................................................................
#....................................................................................
#....................................................................................
#.................comparison of henipa and filo......................................

batphy1 <- batphy1 %>%
  mutate(hnv_surv = ifelse(is.na(hnv_surv), 0, hnv_surv)) 

taxonomy<- batphy1[,c('species','tax')]

n_factors = 10

#........................henipaviruses...............................

Z.hnv <- batphy1$hnv_surv

pf.hvn <- phylofactor::twoSampleFactor(Z.hnv, bat_tree, method='Fisher', n_factors ,ncores = 1)

nms <- list()

for (i in 2:length(pf.hvn$bins))
{
  indexes = pf.hvn$bins[[i]]
  species <- gsub("_", " ", tolower(bat_tree$tip.label[indexes]))
  group_taxonomy_list <- as.data.frame(taxonomy[match(species,taxonomy[,1]),2])
  
  nms[i] <- gsub("\\)|;","", as.character(taxonomy_group_name(group_taxonomy_list)))
  
  print(i)
}

B <- bins(pf.hvn$basis[,1:n_factors])
B <- B[2:n_factors] 
nms1.hvn <- nms[2:(n_factors+1)]

## remove paraphyletic bin

probs <- sapply(B,FUN=function(ix,Z.hnv) mean(Z.hnv[ix]),Z.hnv=Z.hnv) %>% signif(.,digits=2)
names(nms1.hvn) <- probs

pf.tree.hvn <- pf.tree(pf.hvn, lwd=0.5)

#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#...............Null Simulation..........................................................

#null_simulations <- pf.nullsim(pf.hvn, reps = 50, nfactors = n_factors, output ='pvals')

#nfactors <- pf$nfactors
obs <- data.frame('Pvals'=pf.hvn$pvals,
                  'factor'=1:n_factors
)
null_simulations_matrix<- matrix(0,50,n_factors)
for (i in 1:50)
{
  null_simulations_matrix[i,] <- null_simulations[[i]]$pvals
}
null_simulations_matrix <- as.data.frame(t(null_simulations_matrix))
ddf.hvn <- cbind(obs,null_simulations_matrix)

ddf.hvn %>%
  tidyr::gather(group, pvalue, c(1,3:22)) %>%
  mutate(color = ifelse(group =='Pvals', "observed", 'simulated')) %>%
  ggplot() +
  geom_line(aes(x = factor, y= log(pvalue), group = group, color = color)) +
  ggtitle('henipavirus virus simulations')

#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................


#...................................filo viruses......................................

Z.filo <- batphy1$filo_surv

pf.filo <- phylofactor::twoSampleFactor(Z.filo, method='Fisher', bat_tree, n_factors ,ncores = 1)

nms <- list()

for (i in 2:length(pf.filo$bins))
{
  indexes = pf.filo$bins[[i]]
  species <- gsub("_", " ", tolower(bat_tree$tip.label[indexes]))
  group_taxonomy_list <- as.data.frame(taxonomy[match(species,taxonomy[,1]),2])
  
  nms[i] <- gsub("\\)|;","", as.character(taxonomy_group_name(group_taxonomy_list)))
  
  print(i)
}

B <- bins(pf.filo$basis[,1:n_factors])
B <- B[2:n_factors] 
nms1.filo <- nms[2:(n_factors+1)]

## remove paraphyletic bin

probs <- sapply(B,FUN=function(ix,Z.filo) mean(Z.filo[ix]),Z.filo=Z.filo) %>% signif(.,digits=2)
names(nms1.filo) <- probs

pf.tree.filo <- pf.tree(pf.filo, lwd=0.5) 

pf.tree.filo$ggplot +
  #ggtree::geom_treescale(linesize=.02, col='green') +  
  ggtree::geom_tippoint(size=3*Z.filo,col='blue')  

#legend('topleft',legend=Legend[1,'names'],fill=Legend[1,'colors'],cex=1.8)

#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#........................................................................................
#...............Null Simulation..........................................................

null_simulations <- pf.nullsim(pf.filo, reps = 50, nfactors = n_factors, output ='pvals')

#nfactors <- pf$nfactors
obs <- data.frame('Pvals'=pf.filo$pvals,
                  'factor'=1:n_factors
                  )
null_simulations_matrix<- matrix(0,50,n_factors)
for (i in 1:50)
{
  null_simulations_matrix[i,] <- null_simulations[[i]]$pvals
}
null_simulations_matrix <- as.data.frame(t(null_simulations_matrix))
ddf.filo <- cbind(obs,null_simulations_matrix)

ddf.filo %>%
  tidyr::gather(group, pvalue, c(1,3:22)) %>%
  mutate(color = ifelse(group =='Pvals', "observed", 'simulated')) %>%
  ggplot() +
  geom_line(aes(x = factor, y= log(pvalue), group = group, color = color)) +
  ggtitle('filo virus simulations') +
  scale_x_continuous(limits=c(0, 10), breaks = seq(1,10, by= 1))
#.................................................................................................
#.................................................................................................
#.................................................................................................
#.................................................................................................


