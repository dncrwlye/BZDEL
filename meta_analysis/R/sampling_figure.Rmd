---
title: "sampling scheme figure"
output: pdf_document
---

```{r, include= FALSE, warning=FALSE, echo=FALSE}
#.................. sampling scheme................

library(knitr)
library(tidyverse)
library(stringi)
library(readxl)

```


```{r, warning=FALSE, echo=FALSE}

x<-seq(0,365,by=1)
amp <- rnorm(n=length(x), mean=.2)
amp <- runif(n=length(x))
y<-amp*sin(.04*x)+amp
y<-y*sd(y)

smooth_y <- vector()
start = 20
exp_value =1.1
for (i in seq(start,length(y)))
{
l <- i-(start-1)
vector_exp <- 1/(exp_value^(2:(start+1)))
smooth_y[i] <- sum(vector_exp * y[i:l]) * (1/sum(vector_exp))
}

smooth_yt <- as.data.frame((as.matrix(smooth_y))) %>%
  mutate(x = row_number())

rect_sampling_point_unique <- c(30, 30*3,  30*5,  30*7,  30*9, 30*11)
rect_sampling_point_unique <- data.frame(
  xmin = rect_sampling_point_unique,
  xmax = rect_sampling_point_unique + 8,
  ymin = 0,
  ymax = 1
)
rect_sampling_point_long <- c(40)
rect_sampling_point_long <- data.frame(
  xmin = rect_sampling_point_long,
  xmax = rect_sampling_point_long + 200,
  ymin = .2,
  ymax = .6
)

singe_time_point <- c(300)
singe_time_point <- data.frame(
  xmin = singe_time_point,
  xmax = singe_time_point + 10,
  ymin = 0,
  ymax = 1
)

# ggplot() +
#   geom_rect(data=rect_sampling_point_unique, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), 
#             fill='blue', alpha=0.2) +
#   geom_rect(data=rect_sampling_point_long, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax, show.legend = TRUE), 
#             fill='green', alpha=0.4) +
#   geom_rect(data=singe_time_point, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), 
#             fill='black', alpha=0.4) +
#   geom_line(data=smooth_yt, aes(y=V1, x=x)) +
#   ylab('seroprevalence') +
#   xlab('julian days') 
  
ggplot() +
  geom_rect(data=rect_sampling_point_unique, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax, 
            fill='Multiple Sampling Events, Multiple Estimates'), color=NA, alpha=0.2) +
  geom_rect(data=rect_sampling_point_long, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax, 
            fill='Multiple Sampling Events, Single Estimate'), color=NA, alpha=0.4) +
  geom_rect(data=singe_time_point, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax, 
            fill='Single Sampling Event, Single Estimate'), color=NA, alpha=0.4) +
  geom_line(data=smooth_yt, aes(y=V1, x=x)) +
  ylab('seroprevalence') +
  xlab('julian days') +
  scale_fill_manual('Sampling & Reporting Strategy', values = c('green', 'blue', 'black'), guide=guide_legend(override.aes = list(alpha = 1))) + 
  theme(legend.position="bottom", legend.justification  = 0, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  guides(fill=guide_legend(nrow=3,byrow=TRUE, title.position = 'top'))
  #ggtitle('sampling schemes of henipavirus/filovirus seroprevalence studies present in published literature') +
  

```
Sampling schemes present in published studies of henipavirus/filovirus sereprevalence in bats. Black represents a single sampling event. Blue represents a longitudinal sampling at bimonthly intervals. Green represents a potentially longitudinal sampling, but the study reports only a single mean estimate of seroprevalence for a given sample period.

\clearpage


```{r, warning=FALSE, echo=FALSE}

#.............ehhhh gonna make a table describing the amount of longitudinal studies.........

MetaAnalysis_Data_New_Version <- read_excel("~/Dropbox_gmail/Dropbox/bat virus meta-analysis/MetaAnalysis Data New Version.xlsx", 
                                            col_types = c("text", "numeric", "text", 
                                                          "text", "text", "text", "text", "text", 
                                                          "text", "text", "text", "text", "text", 
                                                          "text", "text", "text", "text", "numeric", "numeric", 
                                                          "numeric", "numeric", "numeric", 
                                                          "numeric", "numeric", "numeric", 
                                                          "numeric", "text", "numeric", "numeric", 
                                                          "numeric", "numeric", "date", "date", 
                                                          "date", "text", "text", "text", "text", 
                                                          "numeric", "text"))

seroprevalence <- MetaAnalysis_Data_New_Version %>%
  filter(study_type == 'Observational ') %>%
  filter(outcome == 'Seroprevalence') %>%
  dplyr::select(title, last_name_of_first_author, virus, study_type, study_design, methodology, species, sex, age_class, sampling_location, sampling_location_two, sample_size, seroprevalence_percentage, single_sampling_point, sampling_date_single_time_point, start_of_sampling, end_of_sampling, assay_cutoff) %>%
  mutate(virus = ifelse((virus == "Ebola" | 
                           virus == "Marburg" | 
                           virus == "Zaire Ebola"|
                           virus == "Sudan virus" | 
                           virus == "Zaire Ebolavirus" | 
                           virus == "Zaire Ebola "|
                           virus == "Reston Ebola"), "Filovirus", 
                        ifelse(virus  == "Nipah" | virus == "Hendra" | virus  == "Henipavirus", "Henipavirus", virus))) %>%
  filter(virus != 'Tioman') %>%
  mutate(sampling_location = tolower(sampling_location)) %>%
  mutate(country = stri_extract_first_regex(sampling_location, '[a-z]+')) %>%
  mutate(species = tolower(species)) %>%
  mutate(species = trimws(species)) %>%
  mutate(species = stri_extract_first_regex(species, '[a-z]+ [a-z]+')) %>%
  mutate(methodology = ifelse(methodology == 'PCR'| methodology == 'RT-PCR'| methodology == "RT-PCR  (urine)"| methodology == "RT-PCR (Oro-pharangyeal swab)", 'PCR based method', 
                              ifelse(methodology == "ELISA" | methodology == "ELISA + WB" | methodology == "Luminex", 'non nAb based method',
                                     ifelse(methodology == "VNT"| methodology == "SNT"| methodology == "Unclear, Presumably Neutralizing Antibodies", "nAb based method", methodology)))) %>%
  mutate(successes = round((1/100)*seroprevalence_percentage * sample_size,0)) 

seroprevalence_total <- seroprevalence %>%
  dplyr::select(title) %>% 
  unique()

explicit_longitudinal<-seroprevalence %>%
  mutate(date_diff = end_of_sampling - start_of_sampling) %>%
  filter(single_sampling_point == 1 | date_diff < 365/12) %>%
  select(title, sampling_date_single_time_point, start_of_sampling, virus, sampling_location, species) %>%
  unique() %>%
  group_by(title, sampling_location, species, virus) %>%
  summarise(counts= n()) %>%
  filter(counts >= 2) %>%
  ungroup() %>%
  select(title) %>%
  unique()
 
single_time_points_but_decent_range<-seroprevalence %>%
  mutate(date_diff = end_of_sampling - start_of_sampling) %>%
  filter(single_sampling_point == 1 | date_diff < 365/12) %>%
  select(title, sampling_date_single_time_point, start_of_sampling, sampling_location, species) %>%
  unique() %>%
  group_by(title, sampling_location, species) %>%
  summarise(counts= n()) %>%
  filter(counts == 1) %>%
  ungroup() %>%
  select(title) %>%
  unique()

pooled_estimates_just_horrible<-seroprevalence %>%
  mutate(date_diff = end_of_sampling - start_of_sampling) %>%
  filter(single_sampling_point == 0 & date_diff >= 365/12) %>%
  select(title, sampling_date_single_time_point, date_diff, start_of_sampling, sampling_location, species) %>%
  unique() %>%
  group_by(title, sampling_location, species, date_diff) %>%
  summarise(counts= n()) %>%
  ungroup() %>%
  select(title) %>%
  unique()

pooled_estimates_just_horrible_mean_std<-seroprevalence %>%
  mutate(date_diff = as.numeric(end_of_sampling - start_of_sampling)) %>%
  filter(single_sampling_point == 0 & date_diff >= 365/12) %>%
  select(title, date_diff) %>%
  unique() %>%
  summarise(mean = mean(date_diff), sd= sd(date_diff))
  

paper_breakdown_table <- matrix(c(
                                  "Total Studies", nrow(seroprevalence_total), "-", "","",
                                  "Multiple Sampling Events, Multiple Estimates", nrow(explicit_longitudinal), round(nrow(explicit_longitudinal)/nrow(seroprevalence_total),3)*100, "", "",
                                  "Single Sampling Event, Single Estimate", nrow(single_time_points_but_decent_range), round(nrow(single_time_points_but_decent_range)/nrow(seroprevalence_total),3)*100, "", "",
                                  "Multiple Sampling Events, Single Estimate", nrow(pooled_estimates_just_horrible), round(nrow(pooled_estimates_just_horrible)/nrow(seroprevalence_total),3)*100, pooled_estimates_just_horrible_mean_std$mean, round(pooled_estimates_just_horrible_mean_std$sd,1)
                                  )
                                  , byrow=TRUE,ncol=5)
kable(paper_breakdown_table, align = 'l', col.names = c('', 'Count', '%', 'Mean', 'Std. Dev.'))

paper_breakdown_table_alternative <- matrix(c(
                                  "Total Studies", nrow(seroprevalence_total), "-", "","",
                                  "Multiple Sampling Events, Multiple Estimates", nrow(explicit_longitudinal), round(nrow(explicit_longitudinal)/nrow(seroprevalence_total),3)*100, "", "",
                                  "Single Sampling Event, Single Estimate", nrow(single_time_points_but_decent_range), round(nrow(single_time_points_but_decent_range)/nrow(seroprevalence_total),3)*100, "", "",
                                  "Multiple Sampling Events, Single Estimate", nrow(pooled_estimates_just_horrible), round(nrow(pooled_estimates_just_horrible)/nrow(seroprevalence_total),3)*100, pooled_estimates_just_horrible_mean_std$mean, round(pooled_estimates_just_horrible_mean_std$sd,1)
                                  )
                                  , byrow=TRUE,ncol=5)
kable(paper_breakdown_table, align = 'l', col.names = c('', 'Count', '%', 'Mean', 'Std. Dev.'))


```
Mean and standard deviation refer to the number of days from the start of the sampling period to the end of the sampling period. 

```{r, warning=FALSE, echo=FALSE}

seroprevalence_ab <- seroprevalence %>%
  select(methodology, assay_cutoff, title) %>%
  unique() %>%
  mutate(assay_cutoff = tolower(assay_cutoff)) %>%
  mutate(assay_cutoff_cat = ifelse(grepl('cycles', assay_cutoff), 'cycle threshold', 
                            ifelse(grepl('dilution' , assay_cutoff), 'dilution threshold', 
                            ifelse(grepl('unclear' , assay_cutoff), 'Unclear/None Given', 
                            ifelse(grepl('ratio' , assay_cutoff), 'Ratio',
                            ifelse(grepl('titer' , assay_cutoff), 'titer',
                            ifelse(grepl('mfi' , assay_cutoff), 'Enzymatic Cutoff (MFI/OD)',
                            ifelse(grepl('od' , assay_cutoff), 'Enzymatic Cutoff (MFI/OD)',
                            ifelse(grepl('distribution' , assay_cutoff), 'distribution',
                                   assay_cutoff))))))))) %>%
  group_by(methodology,assay_cutoff_cat) %>%
  summarise(count = n())

unique(seroprevalence_ab$assay_cutoff_cat)
unique(seroprevalence_ab$assay_cutoff)

```



